import streamlit as st
import google.generativeai as genai
import random

# 1. ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∑ö ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä
st.set_page_config(
    page_title="Pali AI Universal Scholar", 
    page_icon="‚ò∏Ô∏è", 
    layout="wide"
)

# --- CSS Styling ---
st.markdown("""
    <style>
    .stApp { background-color: #fdfaf5; }
    .main-title { 
        color: #4a235a; 
        text-align: center; 
        font-size: 30px; 
        font-weight: bold; 
        padding: 10px;
        border-bottom: 3px solid #8e44ad;
    }
    .sub-subtitle {
        text-align: center;
        color: #633971;
        font-size: 18px;
        margin-top: -10px;
        font-weight: 500;
    }
    .footer { 
        text-align: center; 
        padding: 20px; 
        color: #7d3c98;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

# 2. API ‡∑É‡∑Ñ Model ‡∂ë‡∂ö ‡∂≠‡∑ù‡∂ª‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ (‡∂Ø‡∑ù‡∑Ç ‡∂∏‡∂ü‡∑Ñ‡∑ê‡∂ª‡∑ì‡∂∏‡∂ß ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑Ö ‡∂ö‡∑ú‡∂ß‡∑É)
def load_model():
    keys = []
    for i in range(1, 6):
        key_name = f"GEMINI_API_KEY_{i}"
        if key_name in st.secrets:
            keys.append(st.secrets[key_name])
    
    if not keys and "GEMINI_API_KEY" in st.secrets:
        keys.append(st.secrets["GEMINI_API_KEY"])

    if not keys:
        st.error("‚ùå API Keys ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.")
        return None

    try:
        selected_key = random.choice(keys)
        genai.configure(api_key=selected_key)
        
        # 404 Error ‡∂ë‡∂ö ‡∑Ä‡∑í‡∑É‡∂≥‡∑ì‡∂∏‡∂ß ‡∑Ä‡∑í‡∑Ä‡∑í‡∂∞ ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í ‡∂±‡∑è‡∂∏‡∂∫‡∂±‡∑ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        # ‡∂∏‡∑ô‡∑Ñ‡∑í‡∂Ø‡∑ì 'models/' ‡∂ã‡∂¥‡∑É‡∂ª‡∑ä‡∂ú‡∂∫ ‡∑É‡∑Ñ‡∑í‡∂≠‡∑Ä ‡∑É‡∑Ñ ‡∂ª‡∑Ñ‡∑í‡∂≠‡∑Ä ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂∫‡∑í
        test_models = ['gemini-1.5-flash', 'gemini-pro', 'models/gemini-1.5-flash', 'models/gemini-pro']
        
        for m_name in test_models:
            try:
                model = genai.GenerativeModel(model_name=m_name)
                # Model ‡∂ë‡∂ö ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∑ö‡∂Ø‡∑ê‡∂∫‡∑í ‡∂∂‡∑ê‡∂Ω‡∑ì‡∂∏‡∂ß ‡∂ö‡∑î‡∂©‡∑è ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∂´‡∂∫‡∂ö‡∑ä
                return model
            except:
                continue
        return None
    except Exception as e:
        st.error(f"Configuration Error: {e}")
        return None

# 3. ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Å‡∑ä‚Äç‡∂ª‡∑í‡∂≠‡∂∫ (Caching ‡∑É‡∂∏‡∂ü)
@st.cache_data(show_spinner=False)
def get_pali_analysis(pali_input):
    model = load_model()
    if model:
        prompt = f"""
        As a world-class Pali Philologist and Tipitaka scholar:
        1. Translate this Pali text into BOTH Sinhala and English: "{pali_input}"
        2. Identify the exact source in the Tipitaka.
        3. Provide a DEEP GRAMMATICAL ANALYSIS in a table.
        4. Explain the context (Nidana).
        """
        try:
            response = model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫: {str(e)}"
    return "AI ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫."

# --- UI Layout ---
st.markdown("<div class='main-title'>‚ò∏Ô∏è Pali AI Universal Scholar</div>", unsafe_allow_html=True)
st.markdown("<p class='sub-subtitle'>‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª ‡∑É‡∑Ñ ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂ö‡∂ª‡∂´ ‡∑É‡∑Ñ‡∑í‡∂≠ ‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂± ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</p>", unsafe_allow_html=True)

tab1, tab2, tab3 = st.tabs(["üîÑ ‡∂¥‡∑è‡∂Ω‡∑í ‚ûî ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω/English", "üî° English ‚ûî ‡∂¥‡∑è‡∂Ω‡∑í", "üìö ‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª"])

with tab1:
    if 'pali_text' not in st.session_state: st.session_state.pali_text = ""
    
    with st.expander("‚å®Ô∏è ‡∂¥‡∑è‡∂Ω‡∑í ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä"):
        chars = ['ƒÅ', 'ƒ´', '≈´', '·πÉ', '·πá', '·∏∑', '·π≠', '·∏ç', '√±', '·πÖ']
        cols = st.columns(10)
        for idx, c in enumerate(chars):
            if cols[idx].button(c):
                st.session_state.pali_text += c
                st.rerun()

    pali_input = st.text_area("‡∂¥‡∑è‡∂Ω‡∑í ‡∂¥‡∑è‡∂®‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:", value=st.session_state.pali_text, height=150)
    st.session_state.pali_text = pali_input

    if st.button("‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", type="primary", use_container_width=True):
        if pali_input.strip():
            with st.spinner('‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...'):
                result = get_pali_analysis(pali_input)
                st.info(result)
        else:
            st.warning("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑è‡∂Ω‡∑í ‡∂¥‡∑è‡∂®‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.")

with tab2:
    eng_input = st.text_area("Enter English text:", height=150)
    if st.button("Translate", use_container_width=True):
        model = load_model()
        if model:
            with st.spinner('Translating...'):
                res = model.generate_content(f"Translate to Pali: {eng_input}")
                st.success(res.text)

with tab3:
    st.markdown("### üìö ‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª")
    st.write("1. [Tipitaka.lk](https://tipitaka.lk)")
    st.write("2. [SuttaCentral](https://suttacentral.net)")

st.markdown("<div class='footer'>Created by Jinusha Dissanayaka</div>", unsafe_allow_html=True)
